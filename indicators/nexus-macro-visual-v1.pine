// © 2025 Nexus Macro Trader (Visual Version)
// @version=6
indicator("Nexus Macro Visual [V1]", shorttitle="NMT Visual", overlay=true)

// NOT: Bu indikatör 'ta.highest' kullandığı için en son tepe/dip değiştikçe çizimleri günceller.
// Bu durum canlı analizde en güncel seviyeyi görmek için idealdir.

var G1 = "Kurulum Ayarları"
int lookback_period = input.int(100, "Büyük Tepe/Dip için Geriye Bakma Periyodu", group=G1)
float risk_reward_1 = input.float(1.0, "TP1 Oranı", group=G1)
float risk_reward_2 = input.float(2.0, "TP2 Oranı", group=G1)
float risk_reward_3 = input.float(3.0, "TP3 Oranı", group=G1)

var array<line> lines_array = array.new<line>()
var array<label> labels_array = array.new<label>()
var array<box> box_array = array.new<box>()

clear_all_drawings() =>
    for item in lines_array => line.delete(item)
    for item in labels_array => label.delete(item)
    for item in box_array => box.delete(item)
    array.clear(lines_array)
    array.clear(labels_array)
    array.clear(box_array)

float highest_high = ta.highest(high, lookback_period)
float lowest_low = ta.lowest(low, lookback_period)
int high_bar_index_offset = ta.highestbars(high, lookback_period)[0]
int low_bar_index_offset = ta.lowestbars(low, lookback_period)[0]

var float major_high = na
var float major_low = na
bool new_major_high = na(major_high) or highest_high > major_high
bool new_major_low = na(major_low) or lowest_low < major_low

if new_major_high or new_major_low
    clear_all_drawings()
    atr = ta.atr(14)
    if new_major_high
        major_high := highest_high
        major_low := na
        float sl = major_high
        float ep = sl - atr
        // Çizim fonksiyonları buraya (Yukarıdaki mantıkla aynı)
        array.push(lines_array, line.new(bar_index + high_bar_index_offset, ep, bar_index + 20, ep, color=color.green, width=2))
        array.push(labels_array, label.new(bar_index + 20, ep, "Entry", style=label.style_label_left, textcolor=color.green))

    if new_major_low
        major_low := lowest_low
        major_high := na
        float sl = major_low
        float ep = sl + atr
        array.push(lines_array, line.new(bar_index + low_bar_index_offset, ep, bar_index + 20, ep, color=color.blue, width=2))
        array.push(labels_array, label.new(bar_index + 20, ep, "Entry", style=label.style_label_left, textcolor=color.blue))
