// Â© 2026 Nexus Macro Trader (v0.0.2)
// @version=6
indicator("Nexus Macro Visual [v0.0.2]", shorttitle="NMT v0.0.2", overlay=true, max_lines_count=500, max_labels_count=500, max_boxes_count=500)

// =============================================================================
// ğŸ›  AYARLAR (KullanÄ±cÄ± TarafÄ±ndan Ã–zelleÅŸtirilebilir)
// =============================================================================
var G1 = "Strateji Parametreleri"
int pivot_len    = input.int(15, "Sinyal Hassasiyeti (Pivot)", minval=1, group=G1)
float rr1        = input.float(1.0, "TP1 OranÄ± (Risk/Ã–dÃ¼l)", group=G1)
float rr2        = input.float(2.0, "TP2 OranÄ± (Risk/Ã–dÃ¼l)", group=G1)
float rr3        = input.float(3.0, "TP3 OranÄ± (Risk/Ã–dÃ¼l)", group=G1)

var G2 = "GÃ¶rsel Ã–zelleÅŸtirme"
color long_col   = input.color(color.new(#00ff00, 0), "AlÄ±ÅŸ Rengi", group=G2)
color short_col  = input.color(color.new(#ff0000, 0), "SatÄ±ÅŸ Rengi", group=G2)
int line_length  = input.int(20, "Ã‡izgi UzunluÄŸu (Bar)", minval=5, group=G2)
bool show_labels = input.bool(true, "Fiyat Etiketlerini GÃ¶ster", group=G2)

// =============================================================================
// ğŸ” ANALÄ°Z MANTIÄI (Repaint Yapmaz - Sabit Sinyal)
// =============================================================================
// Pivot noktalarÄ±, saÄŸÄ±nda ve solunda belirlenen bar sayÄ±sÄ± kadar tepe/dip arar.
// Bu sayede sinyal oluÅŸtuktan sonra fiyat ne yaparsa yapsÄ±n yer deÄŸiÅŸtirmez.
float ph = ta.pivothigh(high, pivot_len, pivot_len)
float pl = ta.pivotlow(low, pivot_len, pivot_len)
float atr = ta.atr(14) // OynaklÄ±ÄŸa gÃ¶re giriÅŸ mesafesi belirlemek iÃ§in ATR

// =============================================================================
// ğŸ¨ GÃ–RSELLEÅTÄ°RME VE Ã‡Ä°ZÄ°MLER
// =============================================================================

// --- SATIÅ (SHORT) KURULUMU ---
if not na(ph)
    float stopLoss = ph
    float entry    = ph - (atr * 0.5) // ATR'ye gÃ¶re giriÅŸ seviyesi
    float risk     = math.abs(stopLoss - entry)
    float tp1      = entry - (risk * rr1)
    float tp2      = entry - (risk * rr2)
    float tp3      = entry - (risk * rr3)
    
    // 1. Tepe NoktasÄ± Kutusu
    box.new(bar_index[pivot_len]-1, high[pivot_len], bar_index[pivot_len]+1, low[pivot_len], 
             border_color=short_col, bgcolor=color.new(short_col, 80))

    // 2. Ä°ÅŸlem Seviyeleri (Ã‡izgiler)
    line.new(bar_index[pivot_len], stopLoss, bar_index + line_length, stopLoss, color=short_col, width=2)
    line.new(bar_index[pivot_len], entry, bar_index + line_length, entry, color=color.gray, width=2)
    line.new(bar_index[pivot_len], tp1, bar_index + line_length, tp1, color=color.orange, width=1, style=line.style_dashed)
    line.new(bar_index[pivot_len], tp3, bar_index + line_length, tp3, color=color.orange, width=1, style=line.style_dashed)

    // 3. Bilgilendirme Etiketleri
    if show_labels
        label.new(bar_index + line_length, stopLoss, "SL: " + str.tostring(stopLoss, format.mintick), style=label.style_label_left, color=na, textcolor=short_col, size=size.small)
        label.new(bar_index + line_length, entry, "ENTRY: " + str.tostring(entry, format.mintick), style=label.style_label_left, color=na, textcolor=color.gray, size=size.small)
        label.new(bar_index + line_length, tp3, "TP3: " + str.tostring(tp3, format.mintick), style=label.style_label_left, color=na, textcolor=color.orange, size=size.small)

// --- ALIÅ (LONG) KURULUMU ---
if not na(pl)
    float stopLoss = pl
    float entry    = pl + (atr * 0.5)
    float risk     = math.abs(entry - stopLoss)
    float tp1      = entry + (risk * rr1)
    float tp2      = entry + (risk * rr2)
    float tp3      = entry + (risk * rr3)

    // 1. Dip NoktasÄ± Kutusu
    box.new(bar_index[pivot_len]-1, high[pivot_len], bar_index[pivot_len]+1, low[pivot_len], 
             border_color=long_col, bgcolor=color.new(long_col, 80))

    // 2. Ä°ÅŸlem Seviyeleri (Ã‡izgiler)
    line.new(bar_index[pivot_len], stopLoss, bar_index + line_length, stopLoss, color=color.red, width=2)
    line.new(bar_index[pivot_len], entry, bar_index + line_length, entry, color=long_col, width=2)
    line.new(bar_index[pivot_len], tp1, bar_index + line_length, tp1, color=color.orange, width=1, style=line.style_dashed)
    line.new(bar_index[pivot_len], tp3, bar_index + line_length, tp3, color=color.orange, width=1, style=line.style_dashed)

    // 3. Bilgilendirme Etiketleri
    if show_labels
        label.new(bar_index + line_length, stopLoss, "SL: " + str.tostring(stopLoss, format.mintick), style=label.style_label_left, color=na, textcolor=color.red, size=size.small)
        label.new(bar_index + line_length, entry, "ENTRY: " + str.tostring(entry, format.mintick), style=label.style_label_left, color=na, textcolor=long_col, size=size.small)
        label.new(bar_index + line_length, tp3, "TP3: " + str.tostring(tp3, format.mintick), style=label.style_label_left, color=na, textcolor=color.orange, size=size.small)
